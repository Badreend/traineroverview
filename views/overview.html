<script src="js/Sortable.js"></script>
<div id="rev_list">
    
    <ul class="drop_box" style="height:280px">
        {{#each rehabilitants}}
        <li class="drag_box" userID="{{this.id}}" >
            <input class="id-holder" type="hidden" name="rehabilitant_id" value="{{this.id}}"/>
            <div class= "img_container_small" >
                    <div class="hexagon_small">
                        <img src="{{this.pictureUrl}}">
                    </div>
                </div>
            <h3>{{this.GetFullName}}</h3>   
        </li>
        {{/each}}
    </ul>
</div>


<form action="/pair_devices" method="POST">
    <div id='available_pods'>
        {{#each game.connectedDevices}}
        <div data-device-id="{{this.id}}" class="drop_box_container">
            <p>
                <input type="hidden" name="device[{{@index}}]_[id]" value="{{this.id}}"/>
                {{this.id}}
            </p>
            <ul class="drop_box">
            </ul>
        </div>
        {{/each}}
        {{#unless game.connectedDevices}}
        <center>
            <h1>Wachten op devices...</h1>
        </center>
        {{/unless}}
    </div>
    <div style="position:fixed; bottom:0; width:100%; text-align:center;">
        <input type="submit" class="btn btn-primary" value="Start Game"/>
    </div>
</form>



<script type="text/javascript">


$(document).ready(function(){
    resort();
});


function resort(){
    $('.drop_box').sortable({
        connectWith: ".drop_box",
        revert:true,
        receive: function(event, ui)
        {
            var list = $(this);
            if (list.attr('id') != "draglist") {
                console.log(list.children())
                if (list.children().length > 1) {
                    // move item back to main_list
                    $(ui.sender).sortable('cancel');
                }
            }
            pairDevices();
        }
    }).disableSelection();
}

function pairDevices(){
    $('.drop_box_container').each(function(idx,elem){
        var rehabilitant = $(elem).find('.drag_box .id-holder');
        var originalName = $(rehabilitant).attr('name');
        
        if(rehabilitant.length == 1){
            originalName = originalName.replace(/device\[[0-9]+\]_\[/,'').replace(']','');
                
            $(rehabilitant).attr('name', 'device['+idx+']_['+originalName+']');
        }
    });
    
    $('.id-holder').each(function(idx,elem){
        var container = $(elem).closest('.drop_box_container');
        var originalName = $(elem).attr('name');
        
        if(container.length == 0)
            $(elem).attr('name', originalName.replace(/device\[[0-9]+\]_\[/,'').replace(']',''));
    });
}

socket.on('newDeviceConnected', function(connectedDeviceId){
    var templatePodHtml = '<div data-device-id="%id%" class="drop_box_container"> \
        <input type="hidden" name="device[%index%]_[id]" value="%id%"/> \
        <p> \
            %id% \
        </p> \
        <ul class="drop_box"> \
        </ul> \
    </div>';
    
    var index = $("#available_pods div[data-device-id]").length; 
    $("#available_pods").append(templatePodHtml.replace(/%id%/g, connectedDeviceId).replace(/%index%/g,index));
    resort();
});

socket.on('deviceDisconnected', function(deviceId){
    $("#available_pods div[data-device-id='"+deviceId+"']").remove();
    resort();
});

</script>