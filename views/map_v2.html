<script src="js/plugins/panzoom.js"></script>
<script src="js/plugins/pointertouch.js"></script>
<div id="rev_list">
	<ul id="draglist" style="height:280px">

		<li   class="drag_box" userID="1231" >
			<img src="imgs/heads/moniek.png">
			<h2>Momo Niek</h2>   
		</li>

		<li   class="drag_box" userID="1231" >
			<img src="imgs/heads/inge.png">
			<h2>Ings</h2>     
		</li>

		<li   class="drag_box" userID="1231">
			<img src="imgs/heads/inge.png">
			<h2>Ings</h2>     
		</li>

		<li   class="drag_box" userID="1231">
			<img src="imgs/heads/inge.png">
			<h2>Ings</h2>    
		</li>

		<li   class="drag_box" userID="1231">
			<img src="imgs/heads/badr.png">
			<h2>Bada man</h2>    
		</li>

		<li   class="drag_box" userID="1231">
			<img src="imgs/heads/badr.png">
			<h2>Ings</h2>     
		</li>

		<li   class="drag_box" userID="1231">
			<img src="imgs/heads/inge.png">
			<h2>Ings</h2>      
		</li>

		<li   class="drag_box" userID="1231">
			<img src="imgs/heads/inge.png">
			<h2>Ings</h2>      
		</li>
	</ul>
</div>

<div id="right_column">
	<div id="header">
		<h1>Overzicht</h1>
	</div>
	<div id="map_info_column">
		<h1> Groep A </h1>
		<div id="game_timer">
			20:01
		</div>
		<div id="info">
			Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque eu urna facilisis, feugiat orci in, semper mi. Praesent eu felis erat. Sed tristique lectus et justo porta, at bibendum dui 
		</div>
	</div>
	<div id="legend">
		<div id="phase1">
			KOUD
		</div>
		<div id="phase2">
			MID
		</div>
		<div id="phase3">
			WARM
		</div>
	</div>


	<section id="inverted-contain">
		<div style="overflow: hidden; position: relative;" class="panzoom-parent">
			<div class="panzoom">
				<div class="marker" device-id="1">
					<div style="border-radius: 50%; width:75px; height:75px; background:#FF1D61; opacity:.8">
	
					</div>
					<div>
						<span class="heartrate-text">Heartrate</span>
					</div>
				</div>
				<img src="imgs/views/map/MRC.jpg">
			</div>
		</div>
	</div>

	

	<style>

		#legend{
			width:200px;
			height:50px;
			position: absolute;
			z-index: 99;
			bottom:0px;
			background: rgba(255,255,255,.9);
			padding-left:10px;
			text-align: center;
			padding-top:10px;
		}
		#phase1{
			width:58px;
			position: relative;
			float:left;
			border-top:10px solid #77a4d6;
			color:#77a4d6;
			font-weight:bold;			
		}
		#phase2{
			width:58px;
			position: relative;
			float:left;
			border-top:10px solid #fddf29;
			color:#fddf29;
			font-weight:bold;
		}
		#phase3{
			width:58px;
			position: relative;
			float:left;
			border-top:10px solid #c66958;
			color:#c66958;
			font-weight:bold;
		}
		#map_info_column{
			width:200px;
			position: absolute;
			z-index: 99;
			background: rgba(255,255,255,.8);
			margin-top:50px;
			padding-bottom:50px;

			padding-top:20px;
			padding-left:10px;
		}
		#map_info_column h1{
			margin:0px;
			font-size:24px;
		}
		#info{
			margin-top:20px;
			width:calc(100% - 10px);
			border-bottom:1px solid;
			text-align: left;
			font-size:12px;
		}
		#game_timer{
			margin-top:20px;
			width:calc(100% - 10px);
			border-bottom:1px solid;
			border-top:1px solid;

			text-align: center;
			font-size:32px;
		}


		#inverted-contain .panzoom-parent
		{ 
			width: 100%; 
			height: 100%; 
		}
		.marker{
			transform: matrix(0.2, 0, 0, 0.2, 500, 400);
			cursor: pointer;
			position: absolute; 
			z-index: 999;
			text-align: center;
		}
		.marker .heartrate-text{
			color: red;
		}
	</style>
	<script>
		var pixelMeterRatio = 1.44;
		var originX = 530;
		var originY = 900;
		var markerScale = 0.5;
		
		(function() {	
			var $section = $('#inverted-contain');
			$section.find('.panzoom').panzoom({
				$zoomIn: $section.find(".zoom-in"),
				$zoomOut: $section.find(".zoom-out"),
				$zoomRange: $section.find(".zoom-range"),
				$reset: $section.find(".reset"),
				startTransform: 'scale(1.1)',
				increment: 0.1,
				minScale: 1,
				contain: 'invert',
				onChange: function(e, panzoom){
					scale = panzoom.getMatrix()[0];
					$(".marker").each(function(idx, elem){
						var mat = matrixToArray($(elem).css("transform"));

					//scaleX
					mat[0] =0.5 * 1/scale;
					//scaleY
					mat[3] =0.5 * 1/scale;

					$(elem).css("transform", arrayToMatrix(mat));
					//test({device_id: 1, heartrate: 89, x: 47.15, y:-41.17});
				});
				}
			}).panzoom('zoom');
		})();
		function matrixToArray(str) {
			return str.match(/(-?[0-9\.]+)/g);
		}
		function arrayToMatrix(arr){
			var str = "matrix(";
				return str + arr[0] +","+arr[1]+","+arr[2]+","+arr[3]+","+arr[4]+","+arr[5]+")";
}

socket.on('dataClient', function(data){
	var device_id = parseInt(data.device_id);
		//var lat = parseFloat(data.lat);
		//var lon = parseFloat(data.lon);
		var x = parseFloat(data.x);
		var y = parseFloat(data.y);
		
		var heartrate = parseInt(data.heartrate);
		
		console.log("id: " + device_id + " - position: " + x + "  " + y);
		console.log("heartrate: " + heartrate);
		
		var deviceMarker = $(".marker[device-id='"+device_id+"']");
		$(deviceMarker).find(".heartrate-text").text(heartrate); 
		
		var mat = matrixToArray($(deviceMarker).css("transform"));

		//posX
		mat[4] = originX + x * pixelMeterRatio - $(deviceMarker).width() * markerScale;
		//posY
		mat[5] = originY - y * pixelMeterRatio - $(deviceMarker).height() * markerScale;

		$(deviceMarker).css("transform", arrayToMatrix(mat));	
	});

	//[ "1.1",	"0", 	"0", 	"1.1", 	"-87.65", 	"62" ]
	//scaleX	skewX	skewY	scaleY	posX		posY
</script>
</section>
