<script src="js/plugins/panzoom.js"></script>
<script src="js/plugins/pointertouch.js"></script>
<script src="js/d3.min.js"></script>

<!-- <div id="rev_colulmn">
	<div id="groupName"> Groep Wo/Vr</div>
	<div id="rev_list">
		<ul id="draglist" style="height:280px">
			<li class="drag_box" device-id="1" >
				<div class= "img_container_small" >
					<div class="hexagon_small">
						<img src="imgs/heads/moniek.jpg" />
					</div>
				</div>
				<h3>Momo Niek</h3>   
			</li>


			<li   class="drag_box" device-id="2" >
				<div class= "img_container_small" >
					<div >
						<img src="imgs/heads/inge.jpg"/>
					</div>
				</div>
				<h3>Ings</h3>     

			</li>

			<li   class="drag_box" device-id="3">
				<div class= "img_container_small" >
					<div class="hexagon_small">
						<img src="imgs/heads/badr.jpg">
					</div>
				</div>   
										<h3>Bada</h3>  

									</li> -->


<!-- 			<li   class="drag_box" device-id="8">
				<img src="imgs/heads/inge.png">
				<h3>Ings</h3>      
				{{#each connectedDevices}}
				<li   class="drag_box" device-id="{{this.id}}" >
					<img src="{{this.rehabilitant.pictureUrl}}">
					<h3>{{this.rehabilitant.GetFullName}}</h3>   
				</li>
				{{/each}}
		</ul>
	</div>

</div> -->





{{> rehabilitantlist }}






	<div id="right_column">
		<div id="header">
			<h1>EVA overzicht</h1>
		</div>
		<div class="graph">

		</div>

		<div id="map_info_column">

			<div id="info">
			<!-- 
			Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque eu urna facilisis, feugiat orci in, semper mi. Praesent eu felis erat. Sed tristique lectus et justo porta, at bibendum dui 
		-->
	</div>
	
</div>
</div>

<script>
var temp_data = [];
var margin = 30;
temp_data = [
{id:1,name:"Momo Niek",diagnose:"Diagnose: knie & rug",min:90,max:135,loc:[{t:undefined,h:95,x:500,y:450},{t:undefined,h:150,x:450,y:435},{t:undefined,h:110,x:432,y:455},{t:undefined,h:120,x:422,y:510},{t:undefined,h:140,x:390,y:450},{t:undefined,h:145,x:380,y:470},{t:undefined,h:70,x:362,y:505},{t:undefined,h:30,x:322,y:500},]},
{id:2,name:"Ings",diagnose:"Diagnose: knie & rug"}
];

var all_revs = [];

var colors = ["#3D7BF7","#36FFAC","#FFEC38","#CC833B","#EB564B"];


createPath(temp_data[0]);
function createPath(_userData){
	var path = "";
	var prevColor = undefined;
	var newline = true;
	for(var i = 0; i < _userData.loc.length; i++){

		var color = undefined;

		if(_userData.loc[i].h < _userData.min){
			if(_userData.loc[i].h < _userData.min-margin){
				color = colors[0];
			}else{
				color = colors[1];
			}
		}else if(_userData.loc[i].h > _userData.max){
			if(_userData.loc[i].h > _userData.max+margin){
				color = colors[4];
			}else{
				color = colors[3];
			}
		}else{
			color = colors[2];
		}

		if(path === ""){
			path += "M";
		}else{
			path += "L";
		}
		path += _userData.loc[i].x+" ";
		path += _userData.loc[i].y+" ";
		;

		if(prevColor !== color || prevColor !== undefined){
			drawPath(path,prevColor);
			path = "";
			path += "M";
			path += _userData.loc[i].x+" ";
			path += _userData.loc[i].y+" ";
		}
		path += " ";
		prevColor = color;
		console.log(" ");
	}

	//	drawPath(path,color);
};

function drawPath(_path,_color){
	var pathContainer = d3.select("#paths");
	pathContainer.append("svg:path")
	.attr("d",_path)
	.attr("stroke",_color)
	.attr("stroke-width",10)
	.attr("fill","none")
	.attr("stroke-linejoin","round")
	.attr("stroke-linecap","round")
	;
}
$('#map').bind('click', function(){
	console.log('clear')
	$('.drag_box').css('opacity', '1');
	$('#info').empty();

});

$('.marker').bind('touchend click', function(){
	var markerId = $(this).attr('device-id')
	;			$('.drag_box').each(function(){
		var dragBoxId = $(this).attr('device-id');
		if(dragBoxId === markerId){
							//-- change player info
							for(var i = 0; i < temp_data.length; i++){
								console.log(temp_data[i].id);
								if(temp_data[i].id === parseInt(markerId)){
									displayInfo(temp_data[i]);
								}
							}
							//
							$(this).css('opacity', '1');
						}else{
							$(this).css('opacity', '.3');
						}
						
					});
});


$('.drag_box').bind('tap click', function(){
	console.log('clicked on dragBox');
	var dragBoxId = $(this).attr('device-id');
	for(var i = 0; i < temp_data.length; i++){
		if(temp_data[i].id === parseInt(dragBoxId)){
			displayInfo(temp_data[i]);
		}
	}
	if(temp_data.length < parseInt(dragBoxId)){
		$('#info').empty();
	}
	$('.drag_box').each(function(){
		if(dragBoxId === $(this).attr('device-id')){
			$(this).css('opacity', '1');
		}else{
			$(this).css('opacity', '.3');

		}
	});
});


function displayInfo(_idData){
	$('#info').empty();
	$('#info').append("<h3>" + _idData.name + "</h3>");
	$('#info').append("<p>" + _idData.diagnose + "</p>");
			//			$('#info').append("<p>" + _idData.diagnose + "</p>");

		}
		//----




		var pixelMeterRatio = 1.44;
		var originX = 530;
		var originY = 900;
		var markerScale = 0.5;
		
		(function() {	
			var $section = $('#inverted-contain');
			$section.find('.panzoom').panzoom({
				$zoomIn: $section.find(".zoom-in"),
				$zoomOut: $section.find(".zoom-out"),
				$zoomRange: $section.find(".zoom-range"),
				$reset: $section.find(".reset"),
				startTransform: 'scale(1.1)',
				increment: 0.1,
				minScale: 1,
				contain: 'invert',
				onChange: function(e, panzoom){
					scale = panzoom.getMatrix()[0];
					$(".marker").each(function(idx, elem){
						var mat = matrixToArray($(elem).css("transform"));

					//scaleX
					mat[0] =0.5 * 1/scale;
					//scaleY
					mat[3] =0.5 * 1/scale;

					$(elem).css("transform", arrayToMatrix(mat));
					//test({device_id: 1, heartrate: 89, x: 47.15, y:-41.17});
				});
				}
			}).panzoom('zoom');
		})();
		function matrixToArray(str) {
			return str.match(/(-?[0-9\.]+)/g);
		}
		function arrayToMatrix(arr){
			var str = "matrix(";
				return str + arr[0] +","+arr[1]+","+arr[2]+","+arr[3]+","+arr[4]+","+arr[5]+")";
}

socket.on('dataClient', function(data){
	var device_id = parseInt(data.device_id);
		//var lat = parseFloat(data.lat);
		//var lon = parseFloat(data.lon);
		var x = parseFloat(data.x);
		var y = parseFloat(data.y);
		
		var heartrate = parseInt(data.heartrate);
		
		console.log("id: " + device_id + " - position: " + x + "  " + y);
		console.log("heartrate: " + heartrate);
		
		var deviceMarker = $(".marker[device-id='"+device_id+"']");
		$(deviceMarker).find(".heartrate-text").text(heartrate); 
		
		var mat = matrixToArray($(deviceMarker).css("transform"));

		//posX
		mat[4] = originX + x * pixelMeterRatio - $(deviceMarker).width() * markerScale;
		//posY
		mat[5] = originY - y * pixelMeterRatio - $(deviceMarker).height() * markerScale;

		$(deviceMarker).css("transform", arrayToMatrix(mat));	
	});

	//[ "1.1",	"0", 	"0", 	"1.1", 	"-87.65", 	"62" ]
	//scaleX	skewX	skewY	scaleY	posX		posY
	</script>

	<script src="js/evaVisualisatie.js"></script>
